name: API Tests
on:
  schedule:
    - cron: '0 6 * * *'  # Run nightly at 6am UTC
  workflow_dispatch:
    inputs:
      run_dev:
        description: 'Run Dev tests'
        type: boolean
        default: true
      run_uat:
        description: 'Run UAT tests'
        type: boolean
        default: false
      focus:
        description: 'Test suite to run'
        required: false
        default: 'All'
        type: choice
        options:
        - 'All'
        - 'Core Cluster Management'
        - 'Security and Authentication'
        - 'Machine Operations'
        - 'Instance Operations'
        - 'Scaling Resource Management'
      region_id_override:
        description: 'Override Region ID (if set, you must also provide flavor, image and network overrides)'
        required: false
        type: string
      flavor_id_override:
        description: 'Override Flavor ID (required when region_id_override is set)'
        required: false
        type: string
      image_id_override:
        description: 'Override Image ID (required when region_id_override is set)'
        required: false
        type: string
      network_id_override:
        description: 'Override Network ID (required when region_id_override is set)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  API-Tests-Dev:
    name: API Tests (dev)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.run_dev == 'true'
    env:
      ENVIRONMENT: dev
      API_BASE_URL: ${{ vars.DEV_API_BASE_URL }}
      IDENTITY_BASE_URL: ${{ vars.DEV_IDENTITY_BASE_URL }}
      REGION_BASE_URL: ${{ vars.DEV_REGION_BASE_URL }}
      API_AUTH_TOKEN: ${{ secrets.DEV_API_AUTH_TOKEN }}
      TEST_ORG_ID: ${{ vars.DEV_TEST_ORG_ID }}
      TEST_PROJECT_ID: ${{ vars.DEV_TEST_PROJECT_ID }}
      TEST_SECONDARY_PROJECT_ID: ${{ vars.DEV_TEST_SECONDARY_PROJECT_ID }}
      TEST_REGION_ID: ${{ inputs.region_id_override || vars.DEV_TEST_REGION_ID }}
      TEST_SECONDARY_REGION_ID: ${{ vars.DEV_TEST_SECONDARY_REGION_ID }}
      TEST_FLAVOR_ID: ${{ inputs.flavor_id_override || vars.DEV_TEST_FLAVOR_ID }}
      TEST_IMAGE_ID: ${{ inputs.image_id_override || vars.DEV_TEST_IMAGE_ID }}
      TEST_NETWORK_ID: ${{ inputs.network_id_override || vars.DEV_TEST_NETWORK_ID }}

    steps:
    - name: Validate region override inputs
      if: github.event_name == 'workflow_dispatch' && inputs.region_id_override != ''
      run: |
        missing=()
        [ -z "${{ inputs.flavor_id_override }}" ] && missing+=("flavor_id_override")
        [ -z "${{ inputs.image_id_override }}" ] && missing+=("image_id_override")
        [ -z "${{ inputs.network_id_override }}" ] && missing+=("network_id_override")
        if [ ${#missing[@]} -gt 0 ]; then
          echo "::error::region_id_override is set but the following required overrides are missing: ${missing[*]}"
          exit 1
        fi

    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v3
      with:
        go-version-file: go.mod
        cache: true

    - name: Touch
      run: make touch

    - name: Run API Tests - All
      if: github.event_name == 'schedule' || github.event.inputs.focus == 'All'
      run: make test-api

    - name: Run API Tests - Focused
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.focus != 'All'
      run: make test-api-focus FOCUS="${{ github.event.inputs.focus }}"

    - name: Archive API Test Results
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: api-test-results-dev
        path: test/api/suites/test-results.json

    - name: Archive API Test JUnit Report
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: api-test-junit-dev
        path: test/api/suites/junit.xml

    - name: Send Slack Notification
      if: ${{ !cancelled() }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        go run test/api/suites/scripts/slack-notify.go test/api/suites/test-results.json "$WORKFLOW_URL"

  API-Tests-UAT:
    name: API Tests (uat)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.run_uat == 'true'
    env:
      ENVIRONMENT: uat
      API_BASE_URL: ${{ vars.UAT_API_BASE_URL }}
      IDENTITY_BASE_URL: ${{ vars.UAT_IDENTITY_BASE_URL }}
      REGION_BASE_URL: ${{ vars.UAT_REGION_BASE_URL }}
      API_AUTH_TOKEN: ${{ secrets.UAT_API_AUTH_TOKEN }}
      TEST_ORG_ID: ${{ vars.UAT_TEST_ORG_ID }}
      TEST_PROJECT_ID: ${{ vars.UAT_TEST_PROJECT_ID }}
      TEST_SECONDARY_PROJECT_ID: ${{ vars.UAT_TEST_SECONDARY_PROJECT_ID }}
      TEST_REGION_ID: ${{ inputs.region_id_override || vars.UAT_TEST_REGION_ID }}
      TEST_SECONDARY_REGION_ID: ${{ vars.UAT_TEST_SECONDARY_REGION_ID }}
      TEST_FLAVOR_ID: ${{ inputs.flavor_id_override || vars.UAT_TEST_FLAVOR_ID }}
      TEST_IMAGE_ID: ${{ inputs.image_id_override || vars.UAT_TEST_IMAGE_ID }}
      TEST_NETWORK_ID: ${{ inputs.network_id_override || vars.UAT_TEST_NETWORK_ID }}

    steps:
    - name: Validate region override inputs
      if: github.event_name == 'workflow_dispatch' && inputs.region_id_override != ''
      run: |
        missing=()
        [ -z "${{ inputs.flavor_id_override }}" ] && missing+=("flavor_id_override")
        [ -z "${{ inputs.image_id_override }}" ] && missing+=("image_id_override")
        [ -z "${{ inputs.network_id_override }}" ] && missing+=("network_id_override")
        if [ ${#missing[@]} -gt 0 ]; then
          echo "::error::region_id_override is set but the following required overrides are missing: ${missing[*]}"
          exit 1
        fi

    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v3
      with:
        go-version-file: go.mod
        cache: true

    - name: Touch
      run: make touch

    - name: Run API Tests - All
      if: github.event_name == 'schedule' || github.event.inputs.focus == 'All'
      run: make test-api

    - name: Run API Tests - Focused
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.focus != 'All'
      run: make test-api-focus FOCUS="${{ github.event.inputs.focus }}"

    - name: Archive API Test Results
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: api-test-results-uat
        path: test/api/suites/test-results.json

    - name: Archive API Test JUnit Report
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v4
      with:
        name: api-test-junit-uat
        path: test/api/suites/junit.xml

    - name: Send Slack Notification
      if: ${{ !cancelled() }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        go run test/api/suites/scripts/slack-notify.go test/api/suites/test-results.json "$WORKFLOW_URL"
